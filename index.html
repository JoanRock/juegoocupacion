<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Ocupa Casillas Online</title>
  <style>
    :root {
      --bg-page: #1f2a38;
      --panel-bg: #2e3b4e;
      --cell-bg: #ffffff;
      --accent: #f39c12;
      --font: 'Segoe UI', Tahoma, sans-serif;
      --token-size: 2rem;
      --trail-alpha: 0.3;
      --sound-vol: 0.4;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      padding: 1rem;
      background: var(--bg-page);
      color: #fff;
      font-family: var(--font);
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    h1 {
      font-size: 2rem;
      margin-bottom: 1rem;
    }
    #player-indicator {
      margin-bottom: 0.5rem;
      font-size: 1.2rem;
      font-weight: bold;
    }
    #name-form {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 1rem;
    }
    #status {
      padding: 0.5rem 1rem;
      border-radius: 6px;
      margin-bottom: 1rem;
      text-align: center;
      background: var(--panel-bg);
    }
    #scores {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 1rem;
    }
    .score {
      background: var(--panel-bg);
      padding: 0.4rem 0.8rem;
      border-radius: 4px;
      display: flex;
      align-items: center;
      gap: 0.4rem;
      font-size: 0.85rem;
    }
    #board {
      display: grid;
      grid-template-columns: repeat(8, 1fr);
      grid-template-rows: repeat(8, 1fr);
      width: 100%;
      max-width: 400px;
      aspect-ratio: 1;
      gap: 2px;
      background: var(--panel-bg);
      padding: 3px;
      border-radius: 6px;
    }
    .cell {
      background: var(--cell-bg);
      position: relative;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 4px;
      transition: transform 0.2s;
    }
    .cell:hover { transform: scale(1.05); }
    .cell.selected { outline: 2px solid var(--accent); }
    .trail {
      position: absolute;
      width: 0.6rem;
      height: 0.6rem;
      border-radius: 50%;
      opacity: var(--trail-alpha);
    }
    .token { font-size: var(--token-size); line-height: 1; z-index: 1; }
    input, button { font-size: 0.9rem; padding: 0.4rem 0.8rem; border-radius: 4px; border: none; }
    button { background: var(--accent); color: #fff; cursor: pointer; }
  </style>
</head>
<body>
  <h1>Ocupa Casillas Online</h1>
  <div id="player-indicator">Eres: Jugador ...</div>
  <div id="name-form">
    <input id="name-input" placeholder="Tu nombre" />
    <button id="name-btn">Guardar nombre</button>
  </div>
  <div id="status">Conectando…</div>
  <div id="scores"></div>
  <div id="board"></div>

  <script defer src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script defer src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <script defer>
    window.addEventListener('load', () => {
      // Configuración Firebase
      const firebaseConfig = {
        apiKey: "AIzaSyCPcfbyxWNJr9DksBdmJrnZe4Fs3ZnINtY",
        authDomain: "juego-ocupacion.firebaseapp.com",
        databaseURL: "https://juego-ocupacion-default-rtdb.europe-west1.firebasedatabase.app",
        projectId: "juego-ocupacion",
        storageBucket: "juego-ocupacion.appspot.com",
        messagingSenderId: "567270483949",
        appId: "1:567270483949:web:7b5150bd422b5175a8e4"
      };
      firebase.initializeApp(firebaseConfig);
      const db = firebase.database();
      const gameRef = db.ref('games/partida1');
      const connectedRef = db.ref('.info/connected');

      // Gestión conexión
      const statusEl = document.getElementById('status');
      connectedRef.on('value', snap => {
        statusEl.textContent = snap.val() ? 'Conectado' : 'Desconectado';
      });

      // ID y asignación de jugador
      let playerId = localStorage.getItem('playerId');
      if (!playerId) { playerId = crypto.randomUUID(); localStorage.setItem('playerId', playerId); }
      const presenceRef = db.ref('presence/' + playerId);
      presenceRef.set(true); presenceRef.onDisconnect().remove();

      const playerIndicator = document.getElementById('player-indicator');
      const nameInput = document.getElementById('name-input');
      const nameBtn = document.getElementById('name-btn');
      const scoresEl = document.getElementById('scores');
      let playerIndex = null;

      // Guardar nombre
      nameBtn.onclick = () => {
        const name = nameInput.value.trim();
        if (!name || playerIndex === null) return;
        gameRef.child('playerNames/' + playerIndex).set(name);
      };

      // Asignar índice de jugador
      gameRef.child('players').transaction(current => {
        const players = current || {};
        for (let i = 0; i < 4; i++) {
          if (!players[i]) { players[i] = playerId; playerIndex = i; break; }
          if (players[i] === playerId) { playerIndex = i; break; }
        }
        return players;
      }).then(() => {
        playerIndicator.textContent = `Eres: Jugador ${playerIndex + 1}`;
      });

      // Render y lógica de juego
      gameRef.on('value', snap => {
        const game = snap.val(); if (!game) return;
        const boardEl = document.getElementById('board'); boardEl.innerHTML = '';

        // Calcular puntuaciones
        const names = game.playerNames || {};
        const counts = [0, 0, 0, 0];
        Object.values(game.trails || {}).forEach(p => counts[p]++);

        // Mostrar scores
        scoresEl.innerHTML = '';
        counts.forEach((pts, i) => {
          const div = document.createElement('div'); div.className = 'score';
          div.textContent = `${names[i] || 'Jugador ' + (i+1)}: ${pts}`;
          scoresEl.appendChild(div);
        });

        // Render celdas
        Object.keys(game.pieces || {}).concat(Object.keys(game.trails || {})).length;
        for (let r = 0; r < 8; r++) {
          for (let c = 0; c < 8; c++) {
            const cell = document.createElement('div'); cell.className = 'cell';
            const key = `${r},${c}`;
            // Trail
            if (game.trails?.[key] != null) {
              const trail = document.createElement('div'); trail.className = 'trail';
              trail.style.backgroundColor = `hsl(${game.trails[key]*90}, 70%, 60%)`;
              cell.appendChild(trail);
            }
            // Piece
            if (game.pieces?.[key] != null) {
              const token = document.createElement('span'); token.className = 'token'; token.textContent = '♟';
              token.style.color = `hsl(${game.pieces[key]*90}, 70%, 50%)`;
              cell.appendChild(token);
              if (game.turn === game.pieces[key] && game.pieces[key] === playerIndex) {
                cell.onclick = () => { localStorage.setItem('selected', key); };
              }
            } else {
              cell.onclick = () => {
                const sel = localStorage.getItem('selected'); if (!sel) return;
                const [sx, sy] = sel.split(',').map(Number), [dx, dy] = [r, c];
                if (Math.abs(dx-sx)<=1 && Math.abs(dy-sy)<=1 && (dx+dy)!=(sx+sy)) {
                  gameRef.transaction(g => {
                    if (!g || g.pieces?.[sel]!==playerIndex || g.turn!==playerIndex) return;
                    g.trails = g.trails || {}; g.trails[sel] = playerIndex;
                    delete g.pieces[sel]; if (g.pieces[key]!=null) delete g.pieces[key];
                    g.pieces[key] = playerIndex;
                    g.turn = (playerIndex + 1) % 4;
                    return g;
                  }); localStorage.removeItem('selected');
                }
              };
            }
            boardEl.appendChild(cell);
          }
        }

        // Fin de juego
        const total = 64;
        const occupied = Object.keys(game.trails || {}).length + Object.keys(game.pieces || {}).length;
        if (occupied === total) {
          const max = Math.max(...counts);
          const winners = counts.map((v,i)=> v===max?i:null).filter(v=>v!=null);
          setTimeout(() => {
            alert(winners.length>1 ? `Empate entre ${winners.map(i=>names[i]||'Jugador '+(i+1)).join(' y ')}` : `¡Gana ${names[winners[0]]||'Jugador '+(winners[0]+1)}!`);
            gameRef.set({
              turn: 0,
              pieces: {'0,0':0,'0,7':1,'7,0':2,'7,7':3},
              trails: {},
              players: game.players,
              playerNames: names
            });
          }, 200);
        }

        statusEl.textContent = `Turno de: ${names[game.turn]||'Jugador '+(game.turn+1)}`;
      });
    });
  </script>
</body>
</html>
