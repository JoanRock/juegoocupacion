<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.7.1/firebase-app.js";
  import {
    getDatabase,
    ref,
    onValue,
    runTransaction,
    get,
    set
  } from "https://www.gstatic.com/firebasejs/11.7.1/firebase-database.js";

  // 1) Configuraci√≥n Firebase
  const firebaseConfig = {
    apiKey: "AIzaSyCPcfbyxWNJr9DksBdmJrnZe4Fs3ZnINtY",
    authDomain: "juego-ocupacion.firebaseapp.com",
    databaseURL: "https://juego-ocupacion-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "juego-ocupacion",
    storageBucket: "juego-ocupacion.appspot.com",
    messagingSenderId: "567270483949",
    appId: "1:567270483949:web:7b5150bd422b5175a8e4"
  };
  const app = initializeApp(firebaseConfig);
  const db  = getDatabase(app);
  console.log("Firebase inicializado", app);

  // 2) Chequeo de conexi√≥n RTDB
  const connRef = ref(db, ".info/connected");
  onValue(connRef, snap => {
    console.log("RTDB conectado?", snap.val());
    document.getElementById("status").textContent =
      snap.val() ? "üîå Conectado a Firebase" : "‚ùå Desconectado";
  });

  // 3) Referencia al juego
  const gameRef = ref(db, "games/partida1");

  // 4) Inicializar partida si no existe
  get(gameRef).then(snap => {
    if (!snap.exists()) {
      console.log("Inicializando partida en RTDB");
      return set(gameRef, {
        turn: 0,
        pieces: { "0,0":0, "7,7":1, "0,7":2, "7,0":3 },
        trails: {}
      });
    }
  }).catch(e => console.error("Error al inicializar:", e));

  // 5) Construir tablero en el DOM
  const SIZE = 8;
  const boardEl = document.getElementById("board");
  console.log("Board element:", boardEl);
  for (let r = 0; r < SIZE; r++) {
    for (let c = 0; c < SIZE; c++) {
      const cell = document.createElement("div");
      cell.className = "cell " + ((r+c)%2 ? "dark" : "");
      cell.dataset.coord = `${r},${c}`;
      cell.onclick = () => onCellClick(cell);
      boardEl.appendChild(cell);
    }
  }
  console.log("Tablero construido");

  // 6) Escuchar estado del juego
  onValue(gameRef, snap => {
    const g = snap.val();
    console.log("Recibido estado:", g);
    if (!g) return;
    // Actualizar interfaz (trazas, fichas, scores, etc.)
    // ... aqu√≠ pones tu l√≥gica de render() ...
  }, e => {
    console.error("Error onValue:", e);
  });

  // 7) L√≥gica de movimiento
  function onCellClick(cell) {
    const src = cell.dataset.coord;
    console.log("Click en celda:", src);
    get(gameRef).then(snap => {
      const g = snap.val();
      console.log("Estado al click:", g);
      // ... aqu√≠ tu l√≥gica de selecci√≥n y moveTransaction ...
    });
  }

  function attemptMove(src, dest) {
    console.log(`Intentando mover de ${src} a ${dest}`);
    runTransaction(gameRef, g => {
      // ... tu l√≥gica de transacci√≥n ...
      return g;
    }, (err,comm,snap) => {
      if (err) console.error("Transacci√≥n error:", err);
      else if (!comm) console.warn("Transacci√≥n no completada");
      else console.log("Movimiento registrado");
    });
  }
</script>
