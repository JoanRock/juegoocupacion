<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Ocupa Casillas – 4 Jugadores</title>
  <style>
    body {
      font-family: sans-serif;
      display: flex; flex-direction: column; align-items: center;
      padding: 20px; background: #f5f5f5;
    }
    h1 { margin-bottom: 5px; }
    #status { margin-bottom: 10px; font-weight: bold; }
    #controls { margin-bottom: 15px; }
    #board {
      display: grid;
      grid-template-columns: repeat(8, 40px);
      gap: 2px;
      background: #444;
      padding: 2px;
      border-radius: 8px;
    }
    .cell {
      width: 40px; height: 40px;
      background: #fff; border-radius: 4px;
      display: flex; align-items: center; justify-content: center;
      cursor: pointer; transition: transform .1s;
    }
    .cell:hover { transform: scale(1.1); }
    /* Trails */
    .trail-player0 { background: #ffdddd; }
    .trail-player1 { background: #ddffdd; }
    .trail-player2 { background: #ddddff; }
    .trail-player3 { background: #ffedcc; }
    /* Pieces */
    .piece-player0 { background: #ff9999; }
    .piece-player1 { background: #99ff99; }
    .piece-player2 { background: #9999ff; }
    .piece-player3 { background: #ffcc99; }
    /* Your piece highlight */
    .my { box-shadow: inset 0 0 0 3px #333; }
  </style>
</head>
<body>
  <h1>Ocupa Casillas</h1>
  <div id="status">Conectando…</div>
  <div id="controls">
    <button id="reset">Reiniciar juego</button>
  </div>
  <div id="board"></div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.7.1/firebase-app.js";
    import {
      getDatabase,
      ref,
      onValue,
      runTransaction,
      set
    } from "https://www.gstatic.com/firebasejs/11.7.1/firebase-database.js";

    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyCPcfbyxWNJr9DksBdmJrnZe4Fs3ZnINtY",
      authDomain: "juego-ocupacion.firebaseapp.com",
      databaseURL: "https://juego-ocupacion-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "juego-ocupacion",
      storageBucket: "juego-ocupacion.appspot.com",
      messagingSenderId: "567270483949",
      appId: "1:567270483949:web:7b5150bd422b5175a8e4"
    };
    const app = initializeApp(firebaseConfig);
    const db  = getDatabase(app);

    // Unique session/player ID
    let sessionId = localStorage.getItem("sessionId");
    if (!sessionId) {
      sessionId = crypto.randomUUID();
      localStorage.setItem("sessionId", sessionId);
    }

    // Game constants
    const gameId = "partida1";
    const gameRef = ref(db, `games/${gameId}`);
    const BOARD_SIZE = 8;
    const initialPositions = {
      0: "0,0",
      1: "7,7",
      2: "0,7",
      3: "7,0"
    };
    const central = new Set(["3,3","3,4","4,3","4,4"]);
    const perimeter = coord => {
      const [x,y] = coord.split(",").map(n=>+n);
      return x===0||x===7||y===0||y===7;
    };

    // Build the board UI
    const boardEl = document.getElementById("board");
    for (let y=0; y<BOARD_SIZE; y++){
      for (let x=0; x<BOARD_SIZE; x++){
        const cell = document.createElement("div");
        cell.classList.add("cell");
        cell.dataset.coord = `${x},${y}`;
        cell.addEventListener("click", () => move(cell.dataset.coord));
        boardEl.appendChild(cell);
      }
    }

    // Reset game to initial state
    document.getElementById("reset").onclick = () => {
      const pieces = {};
      for (let pid in initialPositions) {
        pieces[ initialPositions[pid] ] = +pid;
      }
      set(gameRef, {
        turn: 0,
        pieces,
        trails: {}
      });
    };

    // Listen for game state updates
    let myPlayer = null;
    onValue(gameRef, snap => {
      const g = snap.val();
      if (!g) return;
      // On first load, determine myPlayer by matching sessionId→player index
      if (myPlayer===null) {
        // Infer mapping from order of initialPositions or expand with sessions as needed
        // Here assume fixed 4 players 0–3
        // (in prod, you'd assign session→pid separately)
        myPlayer = Object.values(initialPositions).includes(Object.keys(g.pieces).find(c=>g.pieces[c]===0)) ? Object.keys(initialPositions).find(i=>initialPositions[i]) : 0;
      }
      document.getElementById("status").textContent = `Turno: ${g.turn}`;
      // Paint cells
      document.querySelectorAll(".cell").forEach(div=>{
        div.className = "cell";
        const coord = div.dataset.coord;
        if (g.trails && g.trails[coord]!=null) {
          div.classList.add(`trail-player${g.trails[coord]}`);
        }
        if (g.pieces && g.pieces[coord]!=null) {
          div.classList.add(`piece-player${g.pieces[coord]}`);
          if (g.pieces[coord]===myPlayer) div.classList.add("my");
        }
      });
    });

    // Attempt a move on click
    function move(to) {
      runTransaction(gameRef, game=>{
        if (!game) return game;
        const pid = game.turn;
        // find my current position
        const old = Object.entries(game.pieces).find(([c,p])=>p===pid);
        if (!old) return; // shouldn't happen
        const [oldCoord] = old;
        const [ox,oy] = oldCoord.split(",").map(n=>+n);
        const [tx,ty] = to.split(",").map(n=>+n);
        const dx = Math.abs(tx-ox), dy = Math.abs(ty-oy);
        // check allowed move: adjacent OR central→perimeter
        const okAdj = dx<=1 && dy<=1 && (dx+dy>0);
        const okJump = central.has(oldCoord) && perimeter(to);
        if (!okAdj && !okJump) return;
        // leave a trail
        game.trails = game.trails||{};
        game.trails[oldCoord] = pid;
        // capture if necessary
        game.pieces = game.pieces||{};
        if (game.pieces[to]!=null && game.pieces[to]!==pid) {
          // opponent piece removed
        }
        // move piece
        delete game.pieces[oldCoord];
        game.pieces[to] = pid;
        // advance turn
        game.turn = (pid+1)%4;
        return game;
      });
    }

    // On load, do an initial reset if no game exists
    setTimeout(()=>{
      getDatabase(app).ref(`games/${gameId}/turn`).get().then(s=>{
        if (!s.exists()) document.getElementById("reset").click();
      });
    }, 500);
  </script>
</body>
</html>
