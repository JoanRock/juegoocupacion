<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Ocupa Casillas – 4 Jugadores</title>
  <style>
    body {
      font-family: sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 20px;
      background: #f5f5f5;
    }
    h1 {
      margin-bottom: 5px;
    }
    #status {
      margin-bottom: 10px;
      font-weight: bold;
    }
    #controls {
      margin-bottom: 15px;
    }
    #board {
      display: grid;
      grid-template-columns: repeat(8, 40px);
      gap: 2px;
      background: #444;
      padding: 2px;
      border-radius: 8px;
    }
    .cell {
      width: 40px;
      height: 40px;
      background: #fff;
      border-radius: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: transform .1s;
    }
    .cell:hover {
      transform: scale(1.1);
    }
    .cell.player0 { background: #ff9999; }
    .cell.player1 { background: #99ff99; }
    .cell.player2 { background: #9999ff; }
    .cell.player3 { background: #ffcc99; }
    .cell.my {
      box-shadow: inset 0 0 0 3px #333;
    }
  </style>
</head>
<body>
  <h1>Ocupa Casillas</h1>
  <div id="status">Conectando…</div>
  <div id="controls">
    <button id="reset">Reiniciar posiciones</button>
  </div>
  <div id="board"></div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.7.1/firebase-app.js";
    import {
      getDatabase,
      ref,
      onValue,
      runTransaction,
      get,
      set
    } from "https://www.gstatic.com/firebasejs/11.7.1/firebase-database.js";

    // Configuración de Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyCPcfbyxWNJr9DksBdmJrnZe4Fs3ZnINtY",
      authDomain: "juego-ocupacion.firebaseapp.com",
      databaseURL: "https://juego-ocupacion-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "juego-ocupacion",
      storageBucket: "juego-ocupacion.appspot.com",
      messagingSenderId: "567270483949",
      appId: "1:567270483949:web:7b5150bd422b5175a8e4"
    };

    const app = initializeApp(firebaseConfig);
    const db  = getDatabase(app);

    // Identificador de sesión único
    let sessionId = localStorage.getItem("sessionId");
    if (!sessionId) {
      sessionId = crypto.randomUUID();
      localStorage.setItem("sessionId", sessionId);
    }

    const gameId     = "partida1";
    const playersRef = ref(db, `games/${gameId}/players`);
    const boardRef   = ref(db, `games/${gameId}/board`);

    // Posiciones iniciales para los 4 jugadores
    const initialPositions = [
      "0,0",  // jugador 0
      "7,7",  // jugador 1
      "0,7",  // jugador 2
      "7,0"   // jugador 3
    ];

    let myIndex = null;

    // Unirse a la partida: asignar un índice 0–3
    runTransaction(playersRef, players => {
      players = players || {};
      if (players[sessionId] === undefined && Object.keys(players).length < 4) {
        players[sessionId] = Object.keys(players).length;
        return players;
      }
      return players;
    });

    // Escuchar cambios en la lista de jugadores
    onValue(playersRef, snap => {
      const players = snap.val() || {};
      if (players[sessionId] !== undefined) {
        myIndex = players[sessionId];
        document.getElementById("status").textContent = `Tu ficha: ${myIndex}`;
        placeInitialToken();
      } else if (Object.keys(players).length >= 4) {
        document.getElementById("status").textContent = "Juego lleno";
      }
    });

    // Colocar ficha inicial en la posición correspondiente
    function placeInitialToken() {
      const pos = initialPositions[myIndex];
      runTransaction(boardRef, board => {
        board = board || {};
        if (!board[pos]) {
          board[pos] = myIndex;
          return board;
        }
        return board;
      });
    }

    // Botón de reiniciar posiciones
    document.getElementById("reset").addEventListener("click", () => {
      const initBoard = {};
      initialPositions.forEach((pos, idx) => {
        initBoard[pos] = idx;
      });
      set(boardRef, initBoard);
    });

    // Dibujar el tablero
    const BOARD_SIZE = 8;
    const boardEl = document.getElementById("board");
    for (let y = 0; y < BOARD_SIZE; y++) {
      for (let x = 0; x < BOARD_SIZE; x++) {
        const cell = document.createElement("div");
        cell.classList.add("cell");
        cell.dataset.x = x;
        cell.dataset.y = y;
        cell.addEventListener("click", () => tryMove(x, y));
        boardEl.appendChild(cell);
      }
    }

    // Sincronizar y repintar
    onValue(boardRef, snap => {
      const board = snap.val() || {};
      document.querySelectorAll(".cell").forEach(div => {
        const key = `${div.dataset.x},${div.dataset.y}`;
        div.className = "cell";
        if (board[key] !== undefined) {
          div.classList.add(`player${board[key]}`);
          if (board[key] === myIndex) div.classList.add("my");
        }
      });
    });

    // Intentar mover ficha un paso en cualquier dirección
    function tryMove(x, y) {
      if (myIndex === null) return;
      const target = `${x},${y}`;
      runTransaction(boardRef, board => {
        board = board || {};
        // buscar mi posición actual
        const entry = Object.entries(board).find(([, pid]) => pid === myIndex);
        if (!entry) return; // no has spawn
        const [oldKey] = entry;
        const [ox, oy] = oldKey.split(",").map(Number);
        const dx = Math.abs(x - ox), dy = Math.abs(y - oy);
        // mover solo si distancia ≤1, destino libre
        if ((dx <= 1 && dy <= 1) && (dx + dy > 0) && board[target] === undefined) {
          delete board[oldKey];
          board[target] = myIndex;
          return board;
        }
        return; // abortar
      });
    }
  </script>
</body>
</html>
