<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Ocupa Casillas – 4 Jugadores</title>
  <style>
    body {
      font-family: sans-serif;
      display: flex; flex-direction: column;
      align-items: center; padding: 20px;
      background: #fafafa;
    }
    h1 { margin-bottom: 5px; }
    #status { margin-bottom: 10px; font-weight: bold; }
    #board {
      display: grid;
      grid-template-columns: repeat(8, 50px);
      gap: 2px; background: #333;
      padding: 2px; border-radius: 8px;
    }
    .cell {
      width: 50px; height: 50px;
      background: #fff; border-radius: 4px;
      display: flex; align-items: center; justify-content: center;
      cursor: pointer; transition: transform .1s;
    }
    .cell:hover { transform: scale(1.05); }
    /* huellas */
    .trail-0 { background: #ffdddd; }
    .trail-1 { background: #ddffdd; }
    .trail-2 { background: #ddddff; }
    .trail-3 { background: #fff0cc; }
    /* piezas */
    .piece-0 { background: #ff6666; }
    .piece-1 { background: #66ff66; }
    .piece-2 { background: #6666ff; }
    .piece-3 { background: #ffb266; }
    .my { box-shadow: inset 0 0 0 3px #000; }
  </style>
</head>
<body>
  <h1>Ocupa Casillas</h1>
  <div id="status">Conectando…</div>
  <button id="reset">Reiniciar juego</button>
  <div id="board"></div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.7.1/firebase-app.js";
    import {
      getDatabase,
      ref,
      onValue,
      runTransaction,
      set,
      get
    } from "https://www.gstatic.com/firebasejs/11.7.1/firebase-database.js";

    // Config Firebase
    const cfg = {
      apiKey: "...", authDomain: "...firebaseapp.com",
      databaseURL: "https://juego-ocupacion-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "juego-ocupacion", storageBucket: "...appspot.com",
      messagingSenderId: "...", appId: "..."
    };
    const app = initializeApp(cfg);
    const db  = getDatabase(app);

    // IDs y referencias
    let sid = localStorage.getItem("sid");
    if (!sid) { sid = crypto.randomUUID(); localStorage.setItem("sid", sid); }
    const gid    = "partida1";
    const gref   = ref(db, `games/${gid}`);
    const pdata  = {}; // {sessionId→idx}
    const size   = 8;
    const center = new Set(["3,3","3,4","4,3","4,4"]);
    const perim  = c => { const [x,y]=c.split(",").map(n=>+n); return x===0||x===7||y===0||y===7; };

    // UI
    const status = document.getElementById("status");
    const board  = document.getElementById("board");
    for(let y=0;y<size;y++){
      for(let x=0;x<size;x++){
        const d = document.createElement("div");
        d.className="cell"; d.dataset.c=`${x},${y}`;
        d.onclick = () => tryMove(d.dataset.c);
        board.appendChild(d);
      }
    }

    // Reiniciar
    document.getElementById("reset").onclick = () => {
      const init = { turn: 0, players: {}, pieces: {}, trails: {} };
      // asigna índices fijos 0–3
      ["0,0","7,7","0,7","7,0"].forEach((c,i)=>{
        init.players["bot"+i]=i; // bots o placeholders
        init.pieces[c]=i;
      });
      set(gref, init);
    };

    // Escuchar cambios globales
    let me = null;
    onValue(gref, snap => {
      const g = snap.val();
      if (!g) return;
      // 1) Asignarme si soy humano y hay plaza
      if (me===null && Object.keys(g.players||{}).length<4) {
        runTransaction(ref(db,`games/${gid}/players/${sid}`),v=>v===null?Object.keys(g.players||{}).length:v);
      }
      // 2) leer mi índice
      if (g.players && g.players[sid]!=null) {
        me = g.players[sid];
      }
      status.textContent = `Turno ▶ Jugador ${g.turn}` + (me!=null?` · Tú eres ${me}`:"");
      // 3) pintar tablero
      document.querySelectorAll(".cell").forEach(d=>{
        const c = d.dataset.c;
        d.className = "cell";
        if (g.trails?.[c]!=null) d.classList.add("trail-"+g.trails[c]);
        if (g.pieces?.[c]!=null){
          d.classList.add("piece-"+g.pieces[c]);
          if (g.pieces[c]===me) d.classList.add("my");
        }
      });
      // 4) chequeo victoria
      const occ = {...g.pieces, ...g.trails};
      if (Object.keys(occ).length===size*size || // tablero lleno
          (new Set(Object.values(g.pieces))).size<=1) { // ≤1 jugador vivo
        const cnt = Object.values(g.trails||{}).reduce((a,i)=>(a[i]=(a[i]||0)+1,a),[]);
        const winner = cnt.indexOf(Math.max(...cnt));
        alert("¡Gana Jugador "+winner+"!");
        document.getElementById("reset").click();
      }
    });

    // Intentar mover
    function tryMove(to){
      runTransaction(gref, g=>{
        if (!g || me===null || g.turn!==me) return;
        // buscar mi pieza
        const old = Object.entries(g.pieces).find(([,p])=>p===me);
        if (!old) return;
        const [o,] = old;
        const [ox,oy]=o.split(",").map(n=>+n);
        const [tx,ty]=to.split(",").map(n=>+n);
        const dx=Math.abs(tx-ox), dy=Math.abs(ty-oy);
        const adj = dx<=1&&dy<=1&&(dx+dy>0);
        const jump = center.has(o)&&perim(to);
        if (!adj&&!jump) return;
        // dejar huella
        g.trails = g.trails||{};
        g.trails[o] = me;
        // capturar oponente
        if (g.pieces[to]!=null && g.pieces[to]!==me) delete g.pieces[to];
        // mover
        delete g.pieces[o];
        g.pieces[to] = me;
        // siguiente turno (skipa eliminados)
        let next = (me+1)%4;
        const alive = new Set(Object.values(g.pieces));
        while (!alive.has(next)) next = (next+1)%4;
        g.turn = next;
        return g;
      });
    }
  </script>
</body>
</html>
