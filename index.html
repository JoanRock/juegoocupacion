<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Ocupa Casillas â€“ 4 Jugadores</title>
  <style>
    body {
      font-family: sans-serif;
      background: #fafafa;
      display: flex; flex-direction: column;
      align-items: center; padding: 20px;
    }
    h1 { margin: 10px 0; }
    #status { margin-bottom: 10px; font-weight: bold; }
    #controls { margin-bottom: 15px; }
    #board {
      display: grid;
      grid-template-columns: repeat(8, 50px);
      gap: 2px;
      background: #333;
      padding: 2px;
      border-radius: 8px;
    }
    .cell {
      width: 50px; height: 50px;
      background: #fff; border-radius: 4px;
      cursor: pointer;
      transition: transform .1s;
    }
    .cell:hover { transform: scale(1.05); }
    /* Trails */
    .trail-0 { background: #ffdddd; }
    .trail-1 { background: #ddffdd; }
    .trail-2 { background: #ddddff; }
    .trail-3 { background: #fff0cc; }
    /* Pieces */
    .piece-0 { background: #ff6666; }
    .piece-1 { background: #66ff66; }
    .piece-2 { background: #6666ff; }
    .piece-3 { background: #ffb266; }
    .my { box-shadow: inset 0 0 0 3px #000; }
  </style>
</head>
<body>
  <h1>Ocupa Casillas</h1>
  <div id="status">Conectandoâ€¦</div>
  <div id="controls">
    <button id="reset">Reiniciar juego</button>
  </div>
  <div id="board"></div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.7.1/firebase-app.js";
    import {
      getDatabase,
      ref,
      onValue,
      runTransaction,
      set,
      get,
      child
    } from "https://www.gstatic.com/firebasejs/11.7.1/firebase-database.js";

    // --- ConfiguraciÃ³n Firebase ---
    const firebaseConfig = {
      apiKey: "AIzaSyCPcfbyxWNJr9DksBdmJrnZe4Fs3ZnINtY",
      authDomain: "juego-ocupacion.firebaseapp.com",
      databaseURL: "https://juego-ocupacion-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "juego-ocupacion",
      storageBucket: "juego-ocupacion.appspot.com",
      messagingSenderId: "567270483949",
      appId: "1:567270483949:web:7b5150bd422b5175a8e4"
    };
    const app = initializeApp(firebaseConfig);
    const db  = getDatabase(app);

    // --- Estado local ---
    let myIdx = null;
    const sessionId = localStorage.sessionId || crypto.randomUUID();
    localStorage.sessionId = sessionId;

    // --- Referencias RTDB ---
    const gameId     = "partida1";
    const gameRef    = ref(db, `games/${gameId}`);
    const playersRef = child(gameRef, "players");
    const turnRef    = child(gameRef, "turn");
    const piecesRef  = child(gameRef, "pieces");
    const trailsRef  = child(gameRef, "trails");

    // --- Constantes de juego ---
    const BOARD_SIZE = 8;
    const CENTER     = new Set(["3,3","3,4","4,3","4,4"]);
    const onPerimeter = c => {
      const [x,y] = c.split(",").map(n=>+n);
      return x===0||x===7||y===0||y===7;
    };

    // --- Construir UI del tablero ---
    const boardEl = document.getElementById("board");
    for (let y = 0; y < BOARD_SIZE; y++) {
      for (let x = 0; x < BOARD_SIZE; x++) {
        const cell = document.createElement("div");
        cell.className = "cell";
        cell.dataset.coord = `${x},${y}`;
        cell.onclick = () => tryMove(cell.dataset.coord);
        boardEl.appendChild(cell);
      }
    }

    // --- FunciÃ³n de reinicio ---
    document.getElementById("reset").onclick = () => {
      set(gameRef, {
        players: {},
        turn: 0,
        // piezas en las 4 esquinas
        pieces: {
          "0,0": 0,
          "7,7": 1,
          "0,7": 2,
          "7,0": 3
        },
        trails: {}
      });
    };

    // --- Inicializar al cargar si no existe partida ---
    get(gameRef).then(snap => {
      if (!snap.exists()) document.getElementById("reset").click();
    });

    // --- Unirse a la partida (transactional) ---
    runTransaction(playersRef, players => {
      players = players || {};
      if (players[sessionId] == null && Object.keys(players).length < 4) {
        players[sessionId] = Object.keys(players).length;
      }
      return players;
    });

    // --- Escuchar actualizaciones del juego ---
    onValue(gameRef, snap => {
      const game = snap.val();
      if (!game) return;

      // Mi Ã­ndice de jugador
      if (game.players[sessionId] != null) {
        myIdx = game.players[sessionId];
      }

      // Estado de turno
      const turn = game.turn ?? 0;
      document.getElementById("status").textContent =
        `Turno â–¶ Jugador ${turn}` + (myIdx!=null?` Â· TÃº: ${myIdx}` : "");

      // Pintar celdas
      document.querySelectorAll(".cell").forEach(c => {
        c.className = "cell";
        const coord = c.dataset.coord;

        // traza
        if (game.trails?.[coord] != null) {
          c.classList.add(`trail-${game.trails[coord]}`);
        }
        // pieza
        if (game.pieces?.[coord] != null) {
          const p = game.pieces[coord];
          c.classList.add(`piece-${p}`);
          if (p === myIdx) c.classList.add("my");
        }
      });

      // Chequeo victoria
      const occCount = Object.keys({
        ...game.trails,
        ...game.pieces
      }).length;
      const alive = new Set(Object.values(game.pieces || {}));
      if (occCount >= BOARD_SIZE*BOARD_SIZE || alive.size <= 1) {
        // contar trazas
        const counts = [0,0,0,0];
        for (let t in game.trails) counts[game.trails[t]]++;
        const winner = counts.indexOf(Math.max(...counts));
        alert(`ðŸŽ‰ Â¡Gana Jugador ${winner}!`);
        document.getElementById("reset").click();
      }
    });

    // --- Intentar mover ---
    function tryMove(dest) {
      runTransaction(gameRef, game => {
        if (!game || myIdx == null || game.turn !== myIdx) return;

        // posiciÃ³n actual
        const oldEntry = Object.entries(game.pieces).find(([,p]) => p === myIdx);
        if (!oldEntry) return;
        const oldCoord = oldEntry[0];
        const [ox,oy] = oldCoord.split(",").map(n=>+n);
        const [dx,dy] = dest.split(",").map(n=>+n).map((v,i)=> i? v-oy : v-ox);
        const adx = Math.abs(dx), ady = Math.abs(dy);

        // validar movimiento
        const normal = (adx<=1 && ady<=1 && (adx+ady>0));
        const teleport = (CENTER.has(oldCoord) && onPerimeter(dest));
        if (!normal && !teleport) return;

        // dejar traza
        game.trails = game.trails||{};
        game.trails[oldCoord] = myIdx;

        // captura de pieza enemiga
        game.pieces = game.pieces||{};
        if (game.pieces[dest] != null && game.pieces[dest] !== myIdx) {
          delete game.pieces[dest];
        }

        // mover pieza
        delete game.pieces[oldCoord];
        game.pieces[dest] = myIdx;

        // eliminar jugadores rodeados
        for (let [coord,p] of Object.entries(game.pieces)) {
          const [cx,cy] = coord.split(",").map(n=>+n);
          let surrounded = true;
          for (let ix = cx-1; ix <= cx+1; ix++) {
            for (let iy = cy-1; iy <= cy+1; iy++) {
              if (ix===cx && iy===cy) continue;
              if (ix<0||iy<0||ix>=BOARD_SIZE||iy>=BOARD_SIZE) {
                surrounded = false;
                break;
              }
              const k = `${ix},${iy}`;
              if (game.pieces[k] == null && game.trails[k] == null) {
                surrounded = false;
                break;
              }
            }
            if (!surrounded) break;
          }
          if (surrounded) delete game.pieces[coord];
        }

        // turno siguiente (skipping eliminados)
        let next = (myIdx + 1) % 4;
        const alive = new Set(Object.values(game.pieces));
        while (!alive.has(next) && alive.size>1) {
          next = (next + 1) % 4;
        }
        game.turn = next;
        return game;
      });
    }
  </script>
</body>
</html>
