<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Ocupa Casillas – 4 Jugadores Mejorado</title>
  <style>
    body {
      font-family: sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 20px;
      background: #f5f5f5;
    }
    h1 { margin-bottom: 5px; }
    #status { margin-bottom: 10px; font-weight: bold; }
    #controls { margin-bottom: 15px; }
    #board {
      display: grid;
      grid-template-columns: repeat(8, 40px);
      gap: 2px;
      background: #444;
      padding: 2px;
      border-radius: 8px;
    }
    .cell {
      width: 40px; height: 40px;
      background: #fff; border-radius: 4px;
      display: flex; align-items: center; justify-content: center;
      cursor: pointer; transition: transform .1s;
    }
    .cell:hover { transform: scale(1.1); }

    /* Trails */
    .trail0 { background: #ffdddd; }
    .trail1 { background: #ddffdd; }
    .trail2 { background: #ddddff; }
    .trail3 { background: #ffeedd; }

    /* Pieces */
    .piece0 { background: #ff5555; }
    .piece1 { background: #55ff55; }
    .piece2 { background: #5555ff; }
    .piece3 { background: #ffdd55; }

    .my { box-shadow: inset 0 0 0 3px #333; }
    .eliminated { opacity: 0.3; }
  </style>
</head>
<body>
  <h1>Ocupa Casillas</h1>
  <div id="status">Conectando…</div>
  <div id="controls">
    <button id="reset">Reiniciar juego</button>
  </div>
  <div id="board"></div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.7.1/firebase-app.js";
    import {
      getDatabase,
      ref,
      onValue,
      runTransaction,
      set
    } from "https://www.gstatic.com/firebasejs/11.7.1/firebase-database.js";

    // Configuración Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyCPcfbyxWNJr9DksBdmJrnZe4Fs3ZnINtY",
      authDomain: "juego-ocupacion.firebaseapp.com",
      databaseURL: "https://juego-ocupacion-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "juego-ocupacion",
      storageBucket: "juego-ocupacion.appspot.com",
      messagingSenderId: "567270483949",
      appId: "1:567270483949:web:7b5150bd422b5175a8e4"
    };
    const app = initializeApp(firebaseConfig);
    const db  = getDatabase(app);

    // Identificador único por sesión
    let sessionId = localStorage.getItem("sessionId");
    if (!sessionId) {
      sessionId = crypto.randomUUID();
      localStorage.setItem("sessionId", sessionId);
    }

    // Referencias base
    const gameId      = "partida1";
    const baseRef     = ref(db, `games/${gameId}`);
    const playersRef  = ref(db, `games/${gameId}/players`);
    const turnRef     = ref(db, `games/${gameId}/turn`);
    const posRef      = ref(db, `games/${gameId}/positions`);
    const trailRef    = ref(db, `games/${gameId}/trails`);
    const elimRef     = ref(db, `games/${gameId}/eliminated`);

    const BOARD_SIZE = 8;
    const initialPos = {
      0: "0,0",
      1: "7,7",
      2: "0,7",
      3: "7,0"
    };
    const central  = new Set(["3,3","3,4","4,3","4,4"]);
    const isPerim  = c => {
      const [x,y]=c.split(",").map(Number);
      return x===0||x===7||y===0||y===7;
    };

    // Unirse y asignar PID
    runTransaction(playersRef, p=>{
      p = p||{};
      if (p[sessionId]===undefined && Object.keys(p).length<4) {
        p[sessionId] = Object.keys(p).length;
      }
      return p;
    });

    let myPid = null;

    // UI: construir tablero
    const boardEl = document.getElementById("board");
    for (let y=0; y<BOARD_SIZE; y++){
      for (let x=0; x<BOARD_SIZE; x++){
        const c = document.createElement("div");
        c.classList.add("cell");
        c.dataset.coord = `${x},${y}`;
        c.addEventListener("click", ()=>move(c.dataset.coord));
        boardEl.appendChild(c);
      }
    }

    // Botón reset: solo resetea posiciones, trails, eliminados y turno
    document.getElementById("reset").onclick = ()=>{
      set(turnRef, 0);
      set(posRef, {});
      set(trailRef, {});
      set(elimRef, {});
    };

    // Escuchar estado completo
    onValue(baseRef, snap=>{
      const g = snap.val();
      if (!g) return;
      // asignar pid
      if (myPid===null && g.players && g.players[sessionId]!==undefined) {
        myPid = g.players[sessionId];
        document.getElementById("status").textContent = `Tu ficha: ${myPid}`;
        // colocar inicial si no existe
        if (!g.positions || g.positions[myPid]===undefined) {
          runTransaction(posRef, pos=>{
            pos = pos||{};
            pos[myPid] = initialPos[myPid];
            return pos;
          });
        }
      }
      // actualizar turno
      document.getElementById("status").textContent =
        `Tu ficha: ${myPid} – Turno de: ${g.turn}`;

      // repintar celdas
      document.querySelectorAll(".cell").forEach(div=>{
        const c = div.dataset.coord;
        div.className = "cell";
        if (g.trails && g.trails[c]!=null) div.classList.add(`trail${g.trails[c]}`);
        if (g.positions) {
          for (let pid in g.positions) {
            if (g.positions[pid]===c) {
              div.classList.add(`piece${pid}`);
              if (Number(pid)===myPid) div.classList.add("my");
            }
          }
        }
        if (g.eliminated && g.eliminated[c]!=null) div.classList.add("eliminated");
      });
    });

    // Función de movimiento
    function move(to) {
      runTransaction(baseRef, g=>{
        if (!g || g.turn===undefined || myPid===null) return;
        const pid = g.turn;
        if (pid!==myPid) return;  // no es tu turno
        g.positions = g.positions||{};
        g.trails    = g.trails||{};
        g.eliminated= g.eliminated||{};
        // posición actual
        const old = g.positions[pid];
        if (!old) return;
        const [ox,oy]=old.split(",").map(Number);
        const [tx,ty]=to.split(",").map(Number);
        const dx=Math.abs(tx-ox), dy=Math.abs(ty-oy);
        const adj = dx<=1 && dy<=1 && (dx+dy>0);
        const jump = central.has(old) && isPerim(to);
        if (!adj && !jump) return;
        // dejar trail
        g.trails[old] = pid;
        // check captura: si otra pieza está en 'to'
        for (let opid in g.positions) {
          if (g.positions[opid]===to && opid!=pid) {
            // eliminar pieza oponente
            delete g.positions[opid];
            g.eliminated[to] = Number(opid);
          }
        }
        // mover pieza
        g.positions[pid] = to;
        // chequeo de rodeo: eliminar rodeados
        for (let opid in g.positions) {
          const pcoord = g.positions[opid];
          const [px,py]=pcoord.split(",").map(Number);
          let surrounded=true;
          for (let ix=-1;ix<=1;ix++) for (let iy=-1;iy<=1;iy++) {
            if (ix===0&&iy===0) continue;
            const nc = `${px+ix},${py+iy}`;
            if (!g.trails[nc] && g.positions[opid]!==nc) surrounded=false;
          }
          if (surrounded) {
            delete g.positions[opid];
            g.eliminated[pcoord]=Number(opid);
          }
        }
        // avanzar turno
        let next=(pid+1)%4;
        const alive = Object.keys(g.positions).map(Number);
        if (!alive.includes(next)) {
          // busca siguiente jugador vivo
          next = alive.length? alive[0] : pid;
        }
        g.turn = next;
        return g;
      });
    }
  </script>
</body>
</html>
