<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Ocupa Casillas</title>
  <style>
    body {
      font-family: sans-serif;
      display: flex; flex-direction: column;
      align-items: center; padding: 20px;
      background: #f5f5f5;
    }
    h1 { margin-bottom: 5px; }
    #status { margin-bottom: 15px; font-weight: bold; }
    #controls {
      margin-bottom: 15px;
    }
    #board {
      display: grid;
      grid-template-columns: repeat(8, 40px);
      gap: 2px;
      background: #444;
      padding: 2px;
      border-radius: 8px;
    }
    .cell {
      width: 40px; height: 40px;
      background: #fff; border-radius: 4px;
      display: flex; align-items: center; justify-content: center;
      cursor: pointer; transition: transform .1s;
    }
    .cell:hover { transform: scale(1.1); }
    .cell.my    { background: #333; }
    .cell.other { background: #aaa; }
  </style>
</head>
<body>
  <h1>Ocupa Casillas</h1>
  <div id="status">Conectando…</div>
  <div id="controls">
    <button id="reset">Reiniciar tablero</button>
  </div>
  <div id="board"></div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.7.1/firebase-app.js";
    import {
      getDatabase,
      ref,
      onValue,
      runTransaction,
      get,
      set
    } from "https://www.gstatic.com/firebasejs/11.7.1/firebase-database.js";

    const config = {
      apiKey: "...",
      authDomain: "juego-ocupacion.firebaseapp.com",
      databaseURL: "https://juego-ocupacion-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "juego-ocupacion",
      storageBucket: "juego-ocupacion.appspot.com",
      messagingSenderId: "567270483949",
      appId: "1:567270483949:web:7b5150bd422b5175a8a9e4",
    };
    const app = initializeApp(config);
    const db  = getDatabase(app);

    // Identificador único de esta sesión
    let myId = localStorage.getItem("sessionId");
    if (!myId) {
      myId = crypto.randomUUID();
      localStorage.setItem("sessionId", myId);
    }
    document.getElementById("status").textContent = `Tu ficha: ${myId}`;

    const gameId   = "partida1";
    const boardRef = ref(db, `games/${gameId}/board`);

    // Inicializa si no existe
    get(boardRef).then(snap => {
      if (!snap.exists()) set(boardRef, {});
    });

    // Botón reiniciar
    document.getElementById("reset").addEventListener("click", () => {
      set(boardRef, {});
    });

    // Dibujar tablero
    const BOARD = 8;
    const boardEl = document.getElementById("board");
    for (let y = 0; y < BOARD; y++) {
      for (let x = 0; x < BOARD; x++) {
        const c = document.createElement("div");
        c.classList.add("cell");
        c.dataset.x = x;
        c.dataset.y = y;
        c.addEventListener("click", () => makeMove(x, y));
        boardEl.appendChild(c);
      }
    }

    // Sincronizar y repintar
    onValue(boardRef, snap => {
      const b = snap.val() || {};
      document.querySelectorAll(".cell").forEach(div => {
        const key = `${div.dataset.x},${div.dataset.y}`;
        div.className = "cell";
        if (b[key]) {
          div.classList.add(b[key] === myId ? "my" : "other");
        }
      });
    });

    // Lógica de movimiento: spawn o mover 1 casilla
    function makeMove(x, y) {
      const target = `${x},${y}`;
      runTransaction(boardRef, board => {
        board = board || {};
        const pos = Object.entries(board).find(([,pid]) => pid === myId);
        if (!pos) {
          if (!board[target]) board[target] = myId;
          return board;
        } else {
          const [oldKey] = pos;
          const [ox, oy] = oldKey.split(",").map(Number);
          const dx = Math.abs(x - ox), dy = Math.abs(y - oy);
          if ((dx <= 1 && dy <= 1) && (dx + dy > 0) && !board[target]) {
            delete board[oldKey];
            board[target] = myId;
            return board;
          }
        }
        return; // aborta
      });
    }
  </script>
</body>
</html>
